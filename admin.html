<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<title>LinkedGenie Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f; --surface: #12121a; --surface2: #1a1a28;
    --border: #2a2a3a; --text: #e8e8f0; --text2: #c4c4d0;
    --text-dim: #8888a0; --text-muted: #66667a;
    --accent: #6366f1; --green: #34d399; --orange: #f59e0b; --red: #f87171;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100vh;
  }

  /* Login Screen */
  .login-screen {
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh; padding: 20px;
  }
  .login-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 40px; width: 100%; max-width: 380px;
    text-align: center;
  }
  .login-box h1 { font-size: 24px; margin-bottom: 8px; }
  .login-box p { font-size: 13px; color: var(--text-dim); margin-bottom: 24px; }
  .login-input {
    width: 100%; padding: 12px 16px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 10px;
    color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px;
    margin-bottom: 12px;
  }
  .login-input:focus { border-color: var(--accent); outline: none; }
  .login-btn {
    width: 100%; padding: 12px; border: none; border-radius: 10px;
    background: var(--accent); color: #fff; font-family: 'DM Sans', sans-serif;
    font-size: 14px; font-weight: 600; cursor: pointer;
  }
  .login-btn:hover { opacity: 0.9; }
  .login-error { color: var(--red); font-size: 12px; margin-top: 8px; display: none; }

  /* Dashboard */
  .dashboard { display: none; max-width: 1000px; margin: 0 auto; padding: 24px; }
  .dash-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border);
  }
  .dash-header h1 { font-size: 22px; }
  .dash-logout {
    padding: 8px 16px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text-muted); font-family: 'DM Sans', sans-serif;
    font-size: 12px; cursor: pointer;
  }
  .dash-logout:hover { border-color: var(--red); color: var(--red); }

  /* Stats */
  .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px; text-align: center;
  }
  .stat-number { font-size: 28px; font-weight: 700; }
  .stat-label { font-size: 12px; color: var(--text-dim); margin-top: 4px; }
  .stat-card.pro .stat-number { color: var(--orange); }
  .stat-card.free .stat-number { color: var(--green); }

  /* Grant Section */
  .grant-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px; margin-bottom: 24px;
  }
  .grant-box h2 { font-size: 16px; margin-bottom: 12px; }
  .grant-row { display: flex; gap: 8px; flex-wrap: wrap; }
  .grant-input {
    flex: 1; min-width: 200px; padding: 10px 14px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 8px; color: var(--text);
    font-family: 'DM Sans', sans-serif; font-size: 13px;
  }
  .grant-input:focus { border-color: var(--accent); outline: none; }
  .grant-select {
    padding: 10px 14px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 13px;
    cursor: pointer;
  }
  .grant-btn {
    padding: 10px 20px; border: none; border-radius: 8px;
    background: var(--green); color: #0a0a0f; font-family: 'DM Sans', sans-serif;
    font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap;
  }
  .grant-btn:hover { opacity: 0.9; }
  .grant-msg { font-size: 12px; margin-top: 8px; display: none; }

  /* Search */
  .search-box { margin-bottom: 16px; }
  .search-input {
    width: 100%; padding: 10px 14px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 8px; color: var(--text);
    font-family: 'DM Sans', sans-serif; font-size: 13px;
  }
  .search-input:focus { border-color: var(--accent); outline: none; }

  /* Users Table */
  .users-table { width: 100%; border-collapse: collapse; }
  .users-table th {
    text-align: left; padding: 10px 12px; font-size: 11px;
    color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
  }
  .users-table td {
    padding: 12px; font-size: 13px; border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }
  .users-table tr:hover td { background: var(--surface2); }
  .badge-pro {
    padding: 2px 8px; border-radius: 100px; font-size: 10px; font-weight: 700;
    background: linear-gradient(135deg, var(--orange), #f97316); color: #1a1a1a;
  }
  .badge-free {
    padding: 2px 8px; border-radius: 100px; font-size: 10px; font-weight: 700;
    background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim);
  }
  .badge-expired {
    padding: 2px 8px; border-radius: 100px; font-size: 10px; font-weight: 700;
    background: rgba(248,113,113,0.15); border: 1px solid rgba(248,113,113,0.3); color: var(--red);
  }
  .action-btn {
    padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;
    cursor: pointer; border: 1px solid var(--border); background: var(--surface2);
    color: var(--text-dim); font-family: 'DM Sans', sans-serif; margin-right: 4px;
  }
  .action-btn:hover { border-color: var(--accent); color: var(--text); }
  .action-btn.revoke:hover { border-color: var(--red); color: var(--red); }
  .action-btn.grant-small:hover { border-color: var(--green); color: var(--green); }
  .sub-info { font-size: 11px; color: var(--text-dim); }

  /* Modal */
  .modal-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    z-index: 100; align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 24px; width: 90%; max-width: 400px;
  }
  .modal-box h3 { font-size: 16px; margin-bottom: 16px; }
  .modal-actions { display: flex; gap: 8px; margin-top: 16px; }
  .modal-btn {
    flex: 1; padding: 10px; border: none; border-radius: 8px;
    font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer;
  }
  .modal-btn.confirm { background: var(--green); color: #0a0a0f; }
  .modal-btn.cancel { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); }

  /* Loading */
  .loading { text-align: center; padding: 40px; color: var(--text-dim); }

  @media (max-width: 600px) {
    .stats-row { grid-template-columns: 1fr; }
    .grant-row { flex-direction: column; }
    .users-table { font-size: 12px; }
    .users-table th, .users-table td { padding: 8px 6px; }
  }
</style>
</head>
<body>

<!-- Login -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <h1>üîê Admin</h1>
    <p>LinkedGenie Subscription Management</p>
    <input type="password" class="login-input" id="secretInput" placeholder="Enter admin secret" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div class="login-error" id="loginError">Invalid secret. Try again.</div>
  </div>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
  <div class="dash-header">
    <h1>‚ú® LinkedGenie Admin</h1>
    <button class="dash-logout" onclick="doLogout()">Logout</button>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card"><div class="stat-number" id="statTotal">‚Äî</div><div class="stat-label">Total Users</div></div>
    <div class="stat-card pro"><div class="stat-number" id="statPro">‚Äî</div><div class="stat-label">Pro Users</div></div>
    <div class="stat-card free"><div class="stat-number" id="statFree">‚Äî</div><div class="stat-label">Free Users</div></div>
  </div>

  <!-- Grant Pro -->
  <div class="grant-box">
    <h2>Grant Pro Access</h2>
    <div class="grant-row">
      <input type="email" class="grant-input" id="grantEmail" placeholder="user@email.com">
      <select class="grant-select" id="grantDuration">
        <option value="7">7 days (Trial)</option>
        <option value="30" selected>30 days (Monthly)</option>
        <option value="90">90 days (3 Months)</option>
        <option value="365">365 days (Yearly)</option>
      </select>
      <button class="grant-btn" onclick="grantPro()">Grant Pro</button>
    </div>
    <div class="grant-msg" id="grantMsg"></div>
  </div>

  <!-- Search -->
  <div class="search-box">
    <input type="text" class="search-input" id="searchInput" placeholder="Search by email or name..." oninput="filterUsers()">
  </div>

  <!-- Users Table -->
  <div id="usersContainer">
    <div class="loading">Loading users...</div>
  </div>
</div>

<!-- Grant Modal -->
<div class="modal-overlay" id="grantModal">
  <div class="modal-box">
    <h3>Grant Pro Access</h3>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px;">
      User: <strong id="modalEmail"></strong>
    </p>
    <select class="grant-select" id="modalDuration" style="width:100%;margin-bottom:8px;">
      <option value="7">7 days (Trial)</option>
      <option value="30" selected>30 days (Monthly)</option>
      <option value="90">90 days (3 Months)</option>
      <option value="365">365 days (Yearly)</option>
    </select>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
      <button class="modal-btn confirm" onclick="confirmGrant()">Grant Pro</button>
    </div>
  </div>
</div>

<script>
let adminSecret = '';
let allUsers = [];

function doLogin() {
  const secret = document.getElementById('secretInput').value.trim();
  if (!secret) return;
  adminSecret = secret;
  // Test by calling list
  apiCall('list').then(data => {
    if (data.error) {
      document.getElementById('loginError').style.display = 'block';
      adminSecret = '';
      return;
    }
    sessionStorage.setItem('admin_secret', secret);
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    renderUsers(data);
  });
}

function doLogout() {
  adminSecret = '';
  sessionStorage.removeItem('admin_secret');
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('secretInput').value = '';
}

// Auto-restore session
(function() {
  const saved = sessionStorage.getItem('admin_secret');
  if (saved) {
    adminSecret = saved;
    apiCall('list').then(data => {
      if (data.error) { doLogout(); return; }
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      renderUsers(data);
    });
  }
})();

async function apiCall(action, extra = {}) {
  try {
    const res = await fetch('/api/admin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminSecret}` },
      body: JSON.stringify({ action, ...extra })
    });
    return await res.json();
  } catch (e) {
    return { error: e.message };
  }
}

function renderUsers(data) {
  allUsers = data.users || [];
  document.getElementById('statTotal').textContent = data.total || 0;
  document.getElementById('statPro').textContent = data.pro || 0;
  document.getElementById('statFree').textContent = (data.total || 0) - (data.pro || 0);
  renderTable(allUsers);
}

function renderTable(users) {
  if (!users.length) {
    document.getElementById('usersContainer').innerHTML = '<div class="loading">No users found</div>';
    return;
  }
  let html = `<table class="users-table">
    <thead><tr>
      <th>User</th><th>Status</th><th>Plan</th><th>Expires</th><th>Usage</th><th>Actions</th>
    </tr></thead><tbody>`;

  for (const u of users) {
    const sub = u.subscription;
    let statusBadge = u.isPro ? '<span class="badge-pro">PRO</span>' : '<span class="badge-free">FREE</span>';
    if (sub?.status === 'expired' || sub?.status === 'revoked') {
      statusBadge = `<span class="badge-expired">${sub.status.toUpperCase()}</span>`;
    }

    let planInfo = '‚Äî';
    if (sub) {
      planInfo = sub.planType || '‚Äî';
    }

    let expiryInfo = '‚Äî';
    if (sub?.expiryDate) {
      const d = new Date(sub.expiryDate);
      const now = new Date();
      const daysLeft = Math.ceil((d - now) / 86400000);
      expiryInfo = d.toLocaleDateString('en', { month: 'short', day: 'numeric', year: 'numeric' });
      if (daysLeft > 0 && u.isPro) {
        expiryInfo += ` <span class="sub-info">(${daysLeft}d)</span>`;
      }
    } else if (sub?.renewalDate) {
      const d = new Date(sub.renewalDate);
      expiryInfo = d.toLocaleDateString('en', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    const usageInfo = u.lastUsage ? `${u.usageCount} (${u.lastUsage})` : '‚Äî';

    const actions = u.isPro
      ? `<button class="action-btn revoke" onclick="revokePro('${u.email}')">Revoke</button>`
      : `<button class="action-btn grant-small" onclick="openGrantModal('${u.email}')">Grant</button>`;

    html += `<tr>
      <td><strong>${u.name || '‚Äî'}</strong><br><span class="sub-info">${u.email}</span></td>
      <td>${statusBadge}</td>
      <td>${planInfo}</td>
      <td>${expiryInfo}</td>
      <td><span class="sub-info">${usageInfo}</span></td>
      <td>${actions}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('usersContainer').innerHTML = html;
}

function filterUsers() {
  const q = document.getElementById('searchInput').value.toLowerCase().trim();
  if (!q) { renderTable(allUsers); return; }
  renderTable(allUsers.filter(u =>
    (u.email || '').toLowerCase().includes(q) ||
    (u.name || '').toLowerCase().includes(q)
  ));
}

async function grantPro() {
  const email = document.getElementById('grantEmail').value.trim();
  const duration = document.getElementById('grantDuration').value;
  const msg = document.getElementById('grantMsg');
  if (!email) { msg.textContent = 'Enter an email'; msg.style.color = 'var(--red)'; msg.style.display = 'block'; return; }

  msg.textContent = 'Granting...'; msg.style.color = 'var(--text-dim)'; msg.style.display = 'block';
  const data = await apiCall('grant', { email, duration: duration + 'd', planType: duration === '7' ? 'trial' : duration === '365' ? 'yearly' : 'monthly' });
  if (data.error) {
    msg.textContent = 'Error: ' + data.error; msg.style.color = 'var(--red)';
  } else {
    msg.textContent = `Pro granted to ${email} for ${data.daysGranted} days`; msg.style.color = 'var(--green)';
    document.getElementById('grantEmail').value = '';
    refreshUsers();
  }
}

async function revokePro(email) {
  if (!confirm(`Revoke Pro from ${email}?`)) return;
  const data = await apiCall('revoke', { email });
  if (data.error) { alert('Error: ' + data.error); return; }
  refreshUsers();
}

function openGrantModal(email) {
  document.getElementById('modalEmail').textContent = email;
  document.getElementById('grantModal').classList.add('open');
}

function closeModal() {
  document.getElementById('grantModal').classList.remove('open');
}

async function confirmGrant() {
  const email = document.getElementById('modalEmail').textContent;
  const duration = document.getElementById('modalDuration').value;
  closeModal();
  const data = await apiCall('grant', { email, duration: duration + 'd', planType: duration === '7' ? 'trial' : duration === '365' ? 'yearly' : 'monthly' });
  if (data.error) { alert('Error: ' + data.error); return; }
  refreshUsers();
}

async function refreshUsers() {
  const data = await apiCall('list');
  if (!data.error) renderUsers(data);
}
</script>
</body>
</html>
